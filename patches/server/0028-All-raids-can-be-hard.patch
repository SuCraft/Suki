From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: MartijnMuijsers <martijnmuijsers@live.nl>
Date: Thu, 9 Jun 2022 01:16:50 +0200
Subject: [PATCH] All raids can be hard


diff --git a/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java b/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java
index cbe597fd9d909cfa13e4b4ca8548f3fc4d2055f5..24af73adecf255a0770fe54e3de841ba2a5a136d 100644
--- a/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java
+++ b/src/main/java/io/papermc/paper/configuration/WorldConfiguration.java
@@ -70,6 +70,7 @@ public class WorldConfiguration extends ConfigurationPart {
 
     public class DifficultyChanges extends ConfigurationPart {
         public boolean zombieReinforcementsOnAllDifficulties = false; // Martijn - zombies can call for reinforcements on all difficulties
+        public boolean raidsAreAlwaysHard = false; // Martijn - raids are always hard
     }
 
     // Martijn end - difficulty changes
diff --git a/src/main/java/net/minecraft/world/entity/raid/Raid.java b/src/main/java/net/minecraft/world/entity/raid/Raid.java
index 5f4bb589474ce7d4f214e32ab0bc4b9cb71638d0..2909c1d762ae487d2cef8a02fed289b48b79fb06 100644
--- a/src/main/java/net/minecraft/world/entity/raid/Raid.java
+++ b/src/main/java/net/minecraft/world/entity/raid/Raid.java
@@ -118,7 +118,7 @@ public class Raid {
         this.raidCooldownTicks = 300;
         this.raidEvent.setProgress(0.0F);
         this.center = pos;
-        this.numGroups = this.getNumGroups(world.getDifficulty());
+        this.numGroups = this.getNumGroups(this.getDifficulty()); // Martijn - raids are always hard
         this.status = Raid.RaidStatus.ONGOING;
     }
 
@@ -150,6 +150,30 @@ public class Raid {
 
     }
 
+    // Martijn start - raids are always hard
+
+    public Difficulty getDifficulty() {
+        Difficulty levelDifficulty = this.level.getDifficulty();
+        return (levelDifficulty != Difficulty.PEACEFUL && this.level.paperConfig().difficultyChanges.raidsAreAlwaysHard) ? Difficulty.HARD : levelDifficulty;
+    }
+
+    public DifficultyInstance getLocalDifficulty(BlockPos pos) {
+        if (!this.level.paperConfig().difficultyChanges.raidsAreAlwaysHard) {
+            // Use the regular method
+            return this.level.getCurrentDifficultyAt(pos);
+        }
+        // This is based on Level.getCurrentlyDifficultyAt(BlockPos), but replaces the level's difficulty by this raid's difficulty
+        long i = 0L;
+        float f = 0.0F;
+        if (this.level.hasChunkAt(pos)) {
+            f = this.level.getMoonBrightness();
+            i = this.level.getChunkAt(pos).getInhabitedTime();
+        }
+        return new DifficultyInstance(this.getDifficulty(), this.level.getDayTime(), i, f);
+    }
+
+    // Martijn end - raids are always hard
+
     public boolean isOver() {
         return this.isVictory() || this.isLoss();
     }
@@ -558,7 +582,7 @@ public class Raid {
         int i = this.groupsSpawned + 1;
 
         this.totalHealth = 0.0F;
-        DifficultyInstance difficultydamagescaler = this.level.getCurrentDifficultyAt(pos);
+        DifficultyInstance difficultydamagescaler = this.getLocalDifficulty(pos); // Martijn - raids are always hard
         boolean flag1 = this.shouldSpawnBonusGroup();
         Raid.RaiderType[] araid_wave = Raid.RaiderType.VALUES;
         int j = araid_wave.length;
@@ -625,7 +649,7 @@ public class Raid {
             raider.setTicksOutsideRaid(0);
             if (!existing && pos != null) {
                 raider.setPos((double) pos.getX() + 0.5D, (double) pos.getY() + 1.0D, (double) pos.getZ() + 0.5D);
-                raider.finalizeSpawn(this.level, this.level.getCurrentDifficultyAt(pos), MobSpawnType.EVENT, (SpawnGroupData) null, (CompoundTag) null);
+                raider.finalizeSpawn(this.level, this.getLocalDifficulty(pos), MobSpawnType.EVENT, (SpawnGroupData) null, (CompoundTag) null); // Martijn - raids are always hard
                 raider.applyRaidBuffs(wave, false);
                 raider.setOnGround(true);
                 this.level.addFreshEntityWithPassengers(raider, org.bukkit.event.entity.CreatureSpawnEvent.SpawnReason.RAID); // CraftBukkit
@@ -791,6 +815,11 @@ public class Raid {
 
     private int getPotentialBonusSpawns(Raid.RaiderType member, RandomSource random, int wave, DifficultyInstance localDifficulty, boolean extra) {
         Difficulty enumdifficulty = localDifficulty.getDifficulty();
+        // Martijn start - raids are always hard
+        if (enumdifficulty != Difficulty.PEACEFUL && this.level.paperConfig().difficultyChanges.raidsAreAlwaysHard) {
+            enumdifficulty = Difficulty.HARD;
+        }
+        // Martijn end - raids are always hard
         boolean flag1 = enumdifficulty == Difficulty.EASY;
         boolean flag2 = enumdifficulty == Difficulty.NORMAL;
         int j;
